---
title: "Cyclotella wallercreekii heritability of growth at different salinities"
date: "04/14/2015"
output: 
  html_document:
    toc: yes
    toc_depth: 5
    theme: united
---

#### Packages and data

```{r}
# read the data
WSALT <- read.csv("./WSALT.csv", header= TRUE)

library(ggplot2)
library(plyr)
library(car)
library(lme4)
library(arm)

```

### Tidy the data

We use the slope of `log(RF) ~ Day` during exponential phase as a measure the growth rate (`r`).

Subset the data to:

  - take Transfers 18-22. All starting at 200 RFU
  - between Days 2 and 5. One less time point sampled compared to C. cryptica

```{r}
last5 <- droplevels(WSALT[which(WSALT$Transfer > 17 & WSALT$Transfer < 23 & WSALT$trDay > 1 & WSALT$trDay < 6), ])
last5 <- mutate(last5,
                Strain=factor(Strain),
                Treatment=factor(Treatment),
                Replicate=factor(Replicate),
                seqRep=factor(seqRep),
                trDay=trDay-1, # so that the first measurement is at day 1
                Rep=factor(Rep),
                Transfer=factor(Transfer))
```

### Growth curves for reference

```{r, fig.width=14, fig.height=14}
 ggplot(data=last5,
      aes(x=Day, y=RF-Rfctrl, ymax=max(RF)*1.05,
        group=factor(Rep), shape=factor(Rep),
        colour=factor(Rep), linetype=factor(Rep))) +
      geom_line(size=0.6) +
      geom_point(size=3) +
      xlab("Day") +
      facet_grid(Strain ~ Treatment) +
      theme_bw()
```


### Following Wood et al. 1987, JPhyc (not run)

- Replicate and Strain are random effects
- Replicate is nested within Strain and Treatment

```{r, eval=FALSE}
## install.packages("arm")

display(lmer(lnRF ~ trDay*Strain + (1 + Strain | Treatment/Rep) + (1|Transfer) , data=last5))

SS <- lmer(mean ~ Treatment + (1 | Strain/Rep) , data=mean_growth)
fixef(SS)
ranef(SS)
anova(SS)
display(SS)
```

* * * 

### cf. Edgar & Theriot 2003, JPhyc

No random effects. Apparently these are difficult to estimate/interpret when the number of levels per factor is small. Here we have 4-5 levels per factor, which apparently is not enough for meaningful among block variance estimation (http://glmm.wikidot.com/faq). It might be possible to use these types of models when I combine the C. cryptica and C. wallercreekii data. We'll have 9 Strains and possibly 10 sequential replicates. For now, use simple `lm` fixed effects model without interactions.

#### For 0 ppt first (not run)

```{r, eval=FALSE}
last5zero <- droplevels(CSALT[which(CSALT$Treatment == 0 & 
                                      CSALT$Transfer > 13 & 
                                      CSALT$trDay > 1 & 
                                      CSALT$trDay < 7), ])

last5zero <- mutate(last5zero,
                Treatment=factor(Treatment),
                Replicate=factor(Replicate),
                seqRep=factor(seqRep),
                trDay=trDay-1, # so that the first measurement is at day 1
                Rep=factor(Rep),
                Transfer=factor(Transfer),
                Strain=factor(Strain))
#head(last5zero)

# fit just the 0 ppt data
noRandEff <- lm(lnRF ~ trDay+Strain+seqRep+Rep , data=last5zero)

aovTable <- Anova(noRandEff, type=3)
aovTable
MSq <- aovTable[,1] / aovTable[,2] # divide SumSq by d.f to get MeanSq
H2 <- MSq[3]/sum(MSq[3:6]) # Var_strain / (Var_strain + Var_transfer + Var_replicate + Var_residual)
Vgen <- MSq[3] # Var_strain
Venv <- MSq[4] + MSq[5] # Var_transfer + Var_replicate
Vres <- MSq[6] # Var_residual

data.frame(H2,Vgen,Venv,Vres)
```

#### Scale to all Treatments

```{r}
linMod <- function(DF) { lm(lnRF ~ trDay+Strain+seqRep+Rep , data=DF)}

noRandEff_all <- dlply(.data=last5,
                       .variables=.(Treatment),
                       .fun=linMod)

aovTable_all <- llply(.data= noRandEff_all,
                      .variables=.(Treatment),
                      .fun=Anova, type=3)

calcHerit <- function(aovTable) {
  MSq <- aovTable[,1] / aovTable[,2] 
  H2 <- MSq[3]/sum(MSq[3:6])
  Vgen <- MSq[3]
  Venv <- MSq[4] + MSq[5]
  Vres <- MSq[6]
  data.frame(H2,Vgen,Venv,Vres)
}

broadSenseH <- ldply(.data=aovTable_all, .fun=calcHerit)
```

#### Adding interaction terms

The effects don't have to be random, but we can still take into account the interactions. The procedure here would be to take the average effects of each type of interaction as variance components.

```{r}
linMod2 <- function(DF) { lm(lnRF ~ trDay + Strain + seqRep + Rep + Strain:seqRep + Strain:Rep + Rep:seqRep, data=DF)}

noRandEff_all2 <- dlply(.data=last5,
                        .variables=.(Treatment),
                        .fun=linMod2)

aovTable_all2 <- llply(.data= noRandEff_all2,
                       .variables=.(Treatment),
                       .fun=Anova, type=3)
aovTable_all2[[1]]

calcHerit2 <- function(aovTable) {
  MSq <- aovTable[,1] / aovTable[,2] 
  H2 <- MSq[3]/sum(MSq[3:9])
  Vgen <- MSq[3]
  Venv <- sum(MSq[4:8])
  Vres <- MSq[9]
  data.frame(H2,Vgen,Venv,Vres)
}

intBroadSenseH <- ldply(.data=aovTable_all2, .fun=calcHerit2)
```

#### Compare

Adding the interactions lowers the heritability and genetic variance. 

```{r}
broadSenseH
intBroadSenseH
```

### Remove cases where cultures didn't grow

```{r}
last5clean <- last5[-which(last5$Strain == "168-16" & last5$Treatment == 24 | 
                           last5$Strain == "168-16" & last5$Treatment == 36 |
                           last5$Strain == "169-30" & last5$Treatment == 36),]
# confirm the drop
table(last5clean$Treatment)
table(last5clean$Strain)
```

#### Model with interaction again

```{r}
clean_noRandEff_all2 <- dlply(.data=last5clean,
                        .variables=.(Treatment),
                        .fun=linMod2)

clean_aovTable_all2 <- llply(.data= clean_noRandEff_all2,
                             .variables=.(Treatment),
                             .fun=Anova, type=3)
clean_intBroadSenseH <- ldply(.data=clean_aovTable_all2, .fun=calcHerit2)
```

#### Compare

With and without the no-growth cases

```{r}
clean_intBroadSenseH
intBroadSenseH
```