---
title: "LMM"
date: "04/13/2015"
output: 
  html_document:
    theme: readable
    toc: yes
    toc_depth: 6
---

```{r}
library(lme4)
library(arm)
library(heritability)
library(ggplot2)
library(plyr)
```

Read and subset the data. Keep the last 5 Transfers, 5 Days per Transfer and only the 0 ppt Treatment. Make sure the factors are factors.

```{r}
CSALT <- read.csv("./CSALT.csv", header= TRUE)

last5zero <- droplevels(CSALT[which(CSALT$Treatment == 0 & 
                                      CSALT$Transfer > 13 & 
                                      CSALT$trDay > 1 & 
                                      CSALT$trDay < 7), ])

last5zero <- mutate(last5zero,
                Treatment=factor(Treatment),
                Replicate=factor(Replicate),
                seqRep=factor(seqRep),
                trDay=trDay-1, # so that the first measurement is at day 1
                Rep=factor(Rep),
                Transfer=factor(Transfer),
                Strain=factor(Strain))
head(last5zero)
```

Make a function to fit and plot model

```{r}
fitPlotRep <- function(Formula, Reform) {
  mod <- lmer(formula = Formula, data=last5zero)

  newDAT <- last5zero
  newDAT$pred <- predict(mod, newDAT, re.form=Reform)
  
  pl <- ggplot(aes(y=lnRF, x=trDay, group=Rep, colour=Rep), data=newDAT) + 
        geom_line(aes(y=pred, group=Rep, colour=Rep), data=newDAT) + 
        geom_point() +
        facet_grid(. ~ Strain) # superimposed doesn't work for some reason?
  return(list(mod, pl))
}

fitPlotSeqRep <- function(Formula, Reform) {
  mod <- lmer(formula = Formula, data=last5zero)

  newDAT <- last5zero
  newDAT$pred <- predict(mod, newDAT, re.form=Reform)
  
  pl <- ggplot(aes(y=lnRF, x=trDay, group=seqRep, colour=seqRep), data=newDAT) + 
        geom_line(aes(y=pred, group=seqRep, colour=seqRep), data=newDAT) + 
        geom_point() +
        facet_grid(. ~ Strain) # superimposed doesn't work for some reason?
  return(list(mod, pl))
}
```

Nesting vs. interacion, as far as I understand it.
 
  - The notation `factorA:factorB` is a 'simple' interaction. It returns only the effects of the combinations of factors A and B
  - The notation `factorA/factorB` is nesting; B is nested in A. It returns the effects of the combinations of factors A and B as well as the 'main' effects of the groups of A.

* * * 

Fit a linear _mixed_ model with different slopes and intercepts using `lmer`. This model is _unaware_ of Replicate or Transfer but aware of Strain.

```{r}
Formula <- formula(lnRF ~ trDay + (1 + trDay | Strain))
Reform <- formula(~(1 + trDay | Strain))
m1 <- fitPlotRep(Formula, Reform)
```

The `fitPlot` function returns a list of the fitted model and a plot. The plot shows that a separate regression was calculated for each Strain. When we look at the fixed effects (`fixef`) in the model we see one intercept and one slope. When we look at the random effects (`ranef`) we see the effect that each Strain has on the coefficients of the model. The way I understand this is that each group in the random effect modifies the coefficients of the fixed effect. So for Strain 331 the slope would be `0.66 + 0.034`.

```{r, fig.width=10, fig.cap="fit of model 1"}
m1[[2]]
fixef(m1[[1]])
ranef(m1[[1]])
```

* * * 

Now lets try to nest Replicate within Strain.

```{r}
Formula <- formula(lnRF ~ trDay + (1 + trDay | Strain/Rep))
Reform <- formula(~(1 + trDay | Strain/Rep))
m2 <- fitPlotRep(Formula, Reform)
```

There are now three regression lines per Strain, one for each Replicate. They have slightly different intercepts, but the same slopes. Not sure how exactly this works, because only two coefficients for the fixed effect are returned; there are no different intercepts. In terms of random effects, we get the same estimates for the grouping by Strain. We also get 12 sets of coefficients for each combination of Strain + Treatment. These are generally smaller than the effects of Strain alone.

```{r, fig.width=10, fig.cap="fit of model 2"}
m2[[2]]
fixef(m2[[1]])
ranef(m2[[1]])
```

* * *

What about separate slopes for each replicate?

```{r}
Formula <- formula(lnRF ~ trDay + (1 + trDay | Strain) + (1 + trDay | Rep))
Reform <- formula(~(1 + trDay | Strain) + (1 + trDay | Rep))
m3 <- fitPlotRep(Formula, Reform)
```

This is not the model I was thinking it was. Fixed effect is the same as before. Random effects are ones for each group of Strain and Replicate regardless of Strain. The plot is different, appears that regression lines are only plotted for reps 2 and 3.

```{r, fig.width=10, fig.cap="fit of model 3"}
m3[[2]]
fixef(m3[[1]])
ranef(m3[[1]])
```

* * *

Another try. What about separate slopes for each replicate? This time nest Strain within Replicate?

```{r}
Formula <- formula(lnRF ~ trDay + (1 + trDay | Rep/Strain))
Reform <- formula(~(1 + trDay | Rep/Strain))
m4 <- fitPlotRep(Formula, Reform)
```

This model produced three regression lines with apparently different slopes but same intercepts. Random effects point to the difference in nesting. The notation `Rep/Strain` means Strain is nested within Replicate; and the `ranef()` output shows coefficients for the interactions `Strain:Rep` plus the effects of each Replicate (very small).

```{r, fig.width=10, fig.cap="fit of model 3"}
m4[[2]]
fixef(m4[[1]])
ranef(m4[[1]])
```

This is not generally what we want, the Replicates should be 'components' of Strain, not the other way around. I think at least.

* * *

Lets add Transfer as a fixed effect

```{r}
Formula <- formula(lnRF ~ trDay + (1+ trDay | Strain) + (1 + trDay | Rep/seqRep) )
Reform <- formula(~(1 + trDay | Strain) + (1 + trDay | Rep/seqRep)  )
m5 <- fitPlotSeqRep(Formula, Reform)
```

```{r, fig.width=10, fig.cap="fit of model 3"}
m5[[2]]
fixef(m5[[1]])
ranef(m5[[1]])
```

* * * 

#### cf. Edgar & Theriot 2003, JPhyc.

No random effects. Apparently these are difficult to estimate/interpret when the number of levels/factor is small. Here we have 4-5 levels per factor, which apparently is not enough for meaningful among block variance estimation (http://glmm.wikidot.com/faq). It might be possible to use these types of models when I combine the C. cryptica and C. wallercreekii data. We'll have 9 Strains and possibly 10 sequential replicates. For now, use simple `lm` fixed effects model with full interaction.

```{r}
library(car)

noRandEff <- lm(lnRF ~ trDay+Strain+seqRep+Rep , data=last5zero)

aovTable <- Anova(noRandEff, type=3)
aovTable
MSq <- aovTable[,1] / aovTable[,2] 
H2 <- MSq[3]/sum(MSq[3:6])
Vgen <- MSq[3]
Venv <- MSq[4] + MSq[5]
Vres <- MSq[6]
data.frame(H2,Vgen,Venv,Vres)
```

Scale to all Treatments:

```{r}
linMod <- lm(lnRF ~ trDay+Strain+seqRep+Rep , data=DF)

```
