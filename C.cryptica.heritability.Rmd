---
title: "Cyclotella cryptica heritability of growth at different salinities"
date: "04/13/2015"
output: 
  html_document:
    toc: yes
    toc_depth: 5
    theme: readable
---

<<<<<<< HEAD
* * * * *

Goal: Estimate broad sense heritability (repeatability) of growth rates in four strains of _C. cryptica_ at different salinities

* * * * * 

#### Packages and data

```{r}
setwd("/home/teo/work/SALINITY_EXPERIMENTS/growth_rates")
=======
#### Packages and data

```{r}
#setwd("/home/teo/work/SALINITY_EXPERIMENTS/growth_rates")
>>>>>>> a4dcc84b9d24c2082117c13a803429d316e58e92

# read the data
CSALT <- read.csv("./CSALT.csv", header= TRUE)

# install and load the packages
# we can probably do this with base R
# but this package has a nice wrapper
# for broad sense heritability

## install.packages("heritability")
library(heritability)
library(ggplot2)
library(plyr)
<<<<<<< HEAD
=======
library(car)
>>>>>>> a4dcc84b9d24c2082117c13a803429d316e58e92
```

#### Calculate the growth rates

We use the slope of `log(RF) ~ Day` during exponential phase as a measure the growth rate (`r`).

Subset the data to:

  - the last 5 Transfers
  - between Days 2 and 6

```{r}
last5 <- droplevels(CSALT[which(CSALT$Transfer > 13 & CSALT$trDay > 1 & CSALT$trDay < 7), ])
<<<<<<< HEAD
last5$trDay <- last5$trDay-1 # so that the first measurement is at day 1
last5 <- mutate(last5,
                Treatment=factor(Treatment),
                Replicate=factor(Replicate),
                seqRep=factor(seqRep),
                trDay=factor(trDay),
=======
last5 <- mutate(last5,
                Strain=factor(Strain),
                Treatment=factor(Treatment),
                Replicate=factor(Replicate),
                seqRep=factor(seqRep),
                trDay=trDay-1, # so that the first measurement is at day 1
>>>>>>> a4dcc84b9d24c2082117c13a803429d316e58e92
                Rep=factor(Rep),
                Transfer=factor(Transfer))
```

Fit all the linear models. Will return a list of `lm` objects.

```{r}
lm_fits <- dlply(.data=last5,
                 .variables=.(Treatment, Strain, Rep, seqRep),
                 .fun=lm, formula=lnRF ~ trDay)
```

Convert to data frame taking the coefficients of the linear model (intercept, slope)

```{r}
df_fits <- ldply(.data=lm_fits,
                 .variables=.(Treatment, Strain, Rep, seqRep),
                 .fun=coefficients)
```

Get the average for each Strain, Treatment, Replicate over the last five Transfers

```{r}
mean_growth <- ddply(.data=df_fits,
                     .variables=.(Treatment, Strain, Rep),
                     .fun=summarize,
                     mean=round(mean(trDay),3))
#mean_growth
```

#### Calculate the heritability

##### At 0 ppt

```{r}
dat.vec <- mean_growth[mean_growth$Treatment==0,]$mean
gen.vec <- mean_growth[mean_growth$Treatment==0,]$Strain

# calculate repeatability
Hzero <- repeatability(data.vector = dat.vec, geno.vector = gen.vec)
<<<<<<< HEAD
#data.frame(H2=Hzero$repeatability, CI=Hzero$conf.int, VG=Hzero$gen.variance,Resid=Hzero$res.variance)
=======
>>>>>>> a4dcc84b9d24c2082117c13a803429d316e58e92
Hzero
```

Appears that we have really high heritability for growth at 0 salinity. These are cultures that originate at 36 ppt or 16 ppt.

<<<<<<< HEAD
##### At all salinities
=======
##### At all salinities individually
>>>>>>> a4dcc84b9d24c2082117c13a803429d316e58e92

```{r}
Herit <- function(df) {
  repeatability(data.vector = df$mean, 
                geno.vector = df$Strain)
}

Hall_list <- dlply(.data=mean_growth,
              .variables=.(Treatment),
              .fun=Herit)

Heritability_all <- data.frame(matrix(unlist(Hall_list),nrow=5,byrow=TRUE))[,c(1,6:7,2:3)]
rownames(Heritability_all) <- c(0,2,12,24,36)
colnames(Heritability_all) <- c("H2","lb","ub","VG","Vres")
Heritability_all

ggplot(aes(y=H2, x=rownames(Heritability_all)), data=Heritability_all) + 
  geom_bar(stat="identity", width=.8, fill="indianred4") +
  geom_errorbar(aes(ymin=lb, ymax=ub), width=.2, data = Heritability_all) +
  xlab("Salinity") + ylab("Heritability") 
```

#### Growth curves for comparison

```{r, fig.width=14, fig.height=14}
 ggplot(data=last5,
      aes(x=Day, y=RF-Rfctrl, ymax=max(RF)*1.05,
        group=factor(Rep), shape=factor(Rep),
        colour=factor(Rep), linetype=factor(Rep))) +
      geom_line(size=0.6) +
      geom_point(size=3) +
      xlab("Day") +
      facet_grid(Strain ~ Treatment) +
      theme_bw()
```

#### Don't average over Transfers

In the analysis above we averaged the 5 estimates per Replicate into a mean slope. Here we'll have two levels of replication:

  - Technical replicates (`Replicate (Rep)`) and
  - Sequential replicates (`Transfer (seqRep)`)

Start with the data frame with coefficients of the linear models. 

```{r}
head(df_fits)

Herit2 <- function(df) {
  repeatability(data.vector = df$trDay, 
                geno.vector = df$Strain)
}

# agnostic about seqRep being nested within Rep
seqRep_Hall_list <- dlply(.data=df_fits,
              .variables=.(Treatment),
              .fun=Herit2)

seqRep_Heritability_all <- data.frame(matrix(unlist(seqRep_Hall_list),nrow=5,byrow=TRUE))[,c(1,6:7,2:3)]
rownames(seqRep_Heritability_all) <- c("0 ppt","2 ppt","12 ppt","24 ppt","36 ppt")
colnames(seqRep_Heritability_all) <- c("H2","lb","ub","VG","Vres")
seqRep_Heritability_all

ggplot(aes(y=H2, x=factor(rownames(seqRep_Heritability_all))), data=seqRep_Heritability_all) + 
  geom_bar(stat="identity", width=.8, fill="indianred4") +
  geom_errorbar(aes(ymin=lb, ymax=ub), width=.2, data = seqRep_Heritability_all) +
  xlab("Salinity") + ylab("Heritability")
```

For comparison, the slopes and their variation 

```{r,fig.width=14}
rep_means <- ddply(.data=df_fits,
                   .variables=.(Treatment),
                   .fun=summarize,
                   Mean=round(mean(trDay),3),
                   Sdev=round(sd(trDay),3))

ggplot(aes(y=Mean, x=factor(Treatment)), data=rep_means) + 
  geom_bar(stat="identity", width=.8, fill="indianred4") +
  geom_errorbar(aes(ymin=Mean-Sdev, ymax=Mean+Sdev), width=.2, data = rep_means) +
  xlab("Salinity") + ylab("Growth rate") #+
  #facet_grid(~Strain)
```

<<<<<<< HEAD
#### With covariates?

Trying to treat Treatment as a fixed effect

```{r}
head(df_fits)
DF <- mutate(.data=df_fits[,c(1,3,4)],
             Treatment=factor(Treatment),
             Rep=factor(Rep),
             seqRep=factor(seqRep))

repeatability(geno.vector = df_fits$Strain, data.vector = df_fits$trDay, covariates.frame = data.frame(DF[,1]))
```

=======
>>>>>>> a4dcc84b9d24c2082117c13a803429d316e58e92
### Following Wood et al. 1987

- Replicate and Strain are random effects
- Replicate is nested within Strain and Treatment

<<<<<<< HEAD
```{r}
library(lme4)
library(arm)

display(lmer(lnRF ~ trDay*Treatment*Strain*Transfer + (1|Strain/Rep) + (1|Treatment/Rep), data=last5))

```





=======
```{r, eval=FALSE}
## install.packages("arm")
library(lme4)
library(arm)

display(lmer(lnRF ~ trDay*Strain + (1 + Strain | Treatment/Rep) + (1|Transfer) , data=last5))

SS <- lmer(mean ~ Treatment + (1 | Strain/Rep) , data=mean_growth)
fixef(SS)
ranef(SS)
anova(SS)
display(SS)
```

* * * 

### cf. Edgar & Theriot 2003, JPhyc.

No random effects. Apparently these are difficult to estimate/interpret when the number of levels per factor is small. Here we have 4-5 levels per factor, which apparently is not enough for meaningful among block variance estimation (http://glmm.wikidot.com/faq). It might be possible to use these types of models when I combine the C. cryptica and C. wallercreekii data. We'll have 9 Strains and possibly 10 sequential replicates. For now, use simple `lm` fixed effects model without interactions.

For 0 ppt first.

```{r}
last5zero <- droplevels(CSALT[which(CSALT$Treatment == 0 & 
                                      CSALT$Transfer > 13 & 
                                      CSALT$trDay > 1 & 
                                      CSALT$trDay < 7), ])

last5zero <- mutate(last5zero,
                Treatment=factor(Treatment),
                Replicate=factor(Replicate),
                seqRep=factor(seqRep),
                trDay=trDay-1, # so that the first measurement is at day 1
                Rep=factor(Rep),
                Transfer=factor(Transfer),
                Strain=factor(Strain))
#head(last5zero)

# fit just the 0 ppt data
noRandEff <- lm(lnRF ~ trDay+Strain+seqRep+Rep , data=last5zero)

aovTable <- Anova(noRandEff, type=3)
aovTable
MSq <- aovTable[,1] / aovTable[,2] # divide SumSq by d.f to get MeanSq
H2 <- MSq[3]/sum(MSq[3:6]) # Var_strain / (Var_strain + Var_transfer + Var_replicate + Var_residual)
Vgen <- MSq[3] # Var_strain
Venv <- MSq[4] + MSq[5] # Var_strain + Var_replicate
Vres <- MSq[6] # Var_residual

data.frame(H2,Vgen,Venv,Vres)
```

Scale to all Treatments:

```{r}
linMod <- function(DF) { lm(lnRF ~ trDay+Strain+seqRep+Rep , data=DF)}

noRandEff_all <- dlply(.data=last5,
                       .variables=.(Treatment),
                       .fun=linMod)

aovTable_all <- llply(.data= noRandEff_all,
                      .variables=.(Treatment),
                      .fun=Anova, type=3)

calcHerit <- function(aovTable) {
  MSq <- aovTable[,1] / aovTable[,2] 
  H2 <- MSq[3]/sum(MSq[3:6])
  Vgen <- MSq[3]
  Venv <- MSq[4] + MSq[5]
  Vres <- MSq[6]
  data.frame(H2,Vgen,Venv,Vres)
}

broadSenseH <- ldply(.data=aovTable_all, .fun=calcHerit)
```

Compare the tables

```{r}
broadSenseH
seqRep_Heritability_all
Heritability_all
```
>>>>>>> a4dcc84b9d24c2082117c13a803429d316e58e92

